---
name: testing
description: "Testing patterns and conventions for TurnStay services"
globs:
  - "app/tests/**/*.py"
alwaysApply: false
---

# Testing Patterns

## Test Structure (Arrange-Act-Assert)

```python
async def test_create_resource(
    client: AsyncClient,
    session: AsyncSession,
    mock_auth_success,  # Always mock authentication
):
    # Arrange
    company = await add_company_to_db(session)
    
    # Act
    response = await client.post(
        "/api/v1/resource",
        json={"name": "Test"},
        headers={"Authorization": "Bearer test_token"}
    )
    
    # Assert
    assert response.status_code == 200
    assert response.json()["name"] == "Test"
```

## Test Requirements

- Use pytest-asyncio with provided fixtures
- Always mock external services (Descope, email, etc.)
- Use `add_*_to_db` fixture helpers for data setup
- Tests must pass `ruff`, `black --check`, and `pytest`

## Common Fixtures

```python
# Database session
async def test_with_session(session: AsyncSession):
    # session is already configured for test database
    pass

# HTTP client
async def test_with_client(client: AsyncClient):
    response = await client.get("/api/v1/health")
    assert response.status_code == 200

# Auth mocking
async def test_authenticated(client: AsyncClient, mock_auth_success):
    # mock_auth_success bypasses Descope validation
    response = await client.get(
        "/api/v1/accounts",
        headers={"Authorization": "Bearer test_token"}
    )
```

## Data Setup Helpers

Use fixture helpers from `app/tests/fixtures/add_fixtures_to_db.py`:

```python
async def test_with_data(session: AsyncSession, mock_auth_success):
    # Create test data
    company = await add_company_to_db(session)
    account = await add_account_to_db(session, company_id=company.id)
    currency = await add_currency_to_db(session)
    
    # Test your endpoint
    ...
```

## Mocking External Services

Always mock external calls:

```python
async def test_with_mocked_service(
    client: AsyncClient,
    session: AsyncSession,
    mock_auth_success,
    mocker,
):
    # Mock external API
    mocker.patch(
        "app.payments.stripe.client.create_payment",
        return_value={"id": "pi_123", "status": "succeeded"}
    )
    
    # Test your endpoint
    ...
```

## Test File Organization

```
app/tests/
├── conftest.py           # Shared fixtures
├── fixtures/             # Data creation helpers
│   ├── add_fixtures_to_db.py
│   └── ...
├── endpoints/            # Endpoint tests
│   ├── test_accounts.py
│   ├── test_payment_intents.py
│   └── ...
├── utils/                # Utility function tests
└── payments/             # Payment provider tests
```

## Running Tests

```bash
# Run all tests
poetry run pytest -v

# Run specific test file
poetry run pytest app/tests/endpoints/test_accounts.py -v

# Run with coverage
poetry run pytest --cov=app --cov-report=html

# Run in parallel (if pytest-xdist installed)
poetry run pytest -n auto
```
